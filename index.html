<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ZenSocial</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: #000; color: #fff; }
    .container { display: grid; grid-template-columns: 18% 52% 30%; height: 100vh; }

    /* Sidebar left */
    .sidebar-left { border-right: 1px solid #2f3336; padding: 20px 15px; display: flex; flex-direction: column; justify-content: space-between; height: 100vh; }
    .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
    .logo i { font-size: 28px; color: #A6FF4D; }
    .logo span { font-size: 26px; font-weight: 700; color: #A6FF4D; }
    .menu { display: flex; flex-direction: column; gap: 20px; }
    .menu-item { display: flex; align-items: center; font-size: 22px; font-weight: 600; cursor: pointer; gap: 15px; padding: 12px 15px; border-radius: 30px; transition: 0.2s; }
    .menu-item a { text-decoration: none; color: #fff; display: flex; align-items: center; gap: 15px; width: 100%; }
    .menu-item:hover { background: #181818; color: #A6FF4D; }
    .menu-item i { font-size: 20px; width: 24px; text-align: center; }
    .post-btn { margin-top: 20px; padding: 14px 0; background: #A6FF4D; border: none; border-radius: 30px; color: #000; cursor: pointer; width: 100%; font-size: 18px; font-weight: 700; transition: 0.2s; }
    .post-btn:hover { background: #90e63c; }

    /* Feed */
    .feed { border-right: 1px solid #2f3336; overflow-y: auto; }
    .composer { border-bottom: 1px solid #2f3336; padding: 15px; background: #000; }
    .composer textarea { width: 100%; background: #000; border: none; color: #fff; resize: none; font-size: 16px; font-family: 'Inter', sans-serif; padding: 10px 0; }
    .composer button { margin-top: 10px; padding: 8px 20px; background: #A6FF4D; border: none; border-radius: 20px; color: #000; cursor: pointer; float: right; font-weight: 600; transition: 0.2s; }
    .composer button:hover { background: #90e63c; }

    .post-card { background:#16181c; padding:15px; margin-top:15px; border-radius:12px; }
    .post-card-header { display:flex; align-items:flex-start; gap:10px; }
    .post-card-header img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .post-card-header .post-info { flex:1; }
    .post-card-header .post-info h3 { margin:0; font-size:15px; }
    .post-card-header .post-info p { margin:4px 0 0; }
    .post-actions { display:flex; gap:30px; margin-top:10px; color:#8899a6; font-size:15px; }
    .post-actions i { cursor:pointer; transition:0.2s; }
    .post-actions i:hover { color:#A6FF4D; }

    /* Right sidebar */
    .sidebar-right { padding: 20px; position: relative; }
    .search-box { margin-bottom: 20px; position: relative; }
    .search-box input { width: 100%; padding: 10px 12px 10px 38px; background: #16181c; border: 1px solid #2f3336; border-radius: 25px; color: #fff; font-size: 14px; }
    .search-box i { position: absolute; top: 50%; left: 14px; transform: translateY(-50%); color: #8899a6; }
    .trending { background: #16181c; border-radius: 16px; padding: 15px; }

    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); }
    .modal-content { background:#16181c; margin:5% auto; padding:20px; border-radius:12px; width:500px; color:#fff; position:relative; }
    .close { position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer; }
    
    /* --- Centering overlay cho #postModal --- */
    #postModal{
      /* .modal đã có position fixed + overlay */
      align-items: center;
      justify-content: center;
      z-index: 9999; /* cao hơn mọi thứ */
    }

    /* ===== UI cho Create Post modal ===== */
    :root{
      --zs-bg:#0b0f14;         /* nền card */
      --zs-bg-2:#12161b;       /* nền editor/toolbar */
      --zs-border:#2f3336;
      --zs-text:#e6e6e6;
      --zs-dim:#94a3b8;
      --zs-accent:#A6FF4D;     /* xanh nút Post */
      --zs-link:#1d9bf0;       /* xanh icon/link */
    }

    #postModal .zs-modal-card{
      width:560px; max-width:95vw;
      background:var(--zs-bg); color:var(--zs-text);
      border:1px solid var(--zs-border); border-radius:16px;
      box-shadow:0 14px 30px rgba(0,0,0,.5); overflow:hidden;
    }

    /* Header */
    .zs-mh{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; }
    .zs-close{ background:transparent; border:none; color:#cbd5e1; font-size:18px;
      width:32px; height:32px; border-radius:9999px; cursor:pointer; }
    .zs-close:hover{ background:#0f172a; }
    .zs-drafts{ color:#cbd5e1; font-size:14px; text-decoration:none; }
    .zs-drafts:hover{ text-decoration:underline; }

    /* User row */
    .zs-userrow{ display:flex; align-items:center; gap:10px; padding:0 14px 10px; }
    .zs-avatar{ width:38px; height:38px; border-radius:50%; object-fit:cover; }
    .zs-visibility{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--zs-bg-2); border:1px solid var(--zs-border);
      color:var(--zs-accent); padding:6px 10px; border-radius:20px; font-size:13px; cursor:pointer;
    }
    .zs-visibility .zs-dot{ width:8px; height:8px; border-radius:50%; background:var(--zs-accent); display:inline-block; }

    /* Editor */
    .zs-editor{ padding:0 14px 10px; }
    .zs-editor textarea{
      width:100%; min-height:90px; border:none; outline:none; resize:vertical;
      background:transparent; color:var(--zs-text); font-size:16px; padding:10px 0;
    }
    .zs-preview{ background:var(--zs-bg-2); border:1px solid var(--zs-border); border-radius:12px; padding:10px; margin-top:8px; }
    .zs-preview img,.zs-preview video{ max-width:100%; border-radius:10px; }

    /* Reply note */
    .zs-reply{ color:var(--zs-link); font-size:13px; padding:0 14px 10px; }

    /* Toolbar */
    .zs-toolbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:var(--zs-bg-2); border-top:1px solid var(--zs-border);
      border-bottom-left-radius:16px; border-bottom-right-radius:16px;
    }
    .zs-tools{ display:flex; align-items:center; gap:14px; color:var(--zs-link); font-size:18px; }
    .zs-tools i{ cursor:pointer; }
    .zs-postbtn{
      border:none; background:var(--zs-accent); color:#0b0f14;
      padding:8px 16px; border-radius:9999px; font-weight:700; cursor:pointer;
    }
    .zs-postbtn:disabled{ opacity:.6; cursor:not-allowed; }

    /* ==== Right column: What's happening (đồng bộ với notifications) ==== */
    .sidebar-right .card{
      background:#101418; border:1px solid #2f3336; border-radius:16px; padding:14px; margin-top:10px;
    }
    .sidebar-right .card h3{ margin:0 0 10px 0; font-size:18px; }
    .sidebar-right .trend{ display:flex; flex-direction:column; gap:6px; padding:10px 0; border-bottom:1px solid #0f1215; }
    .sidebar-right .trend:last-child{ border-bottom:none; }
    .sidebar-right .trend .meta{ color:#9aa6b2; font-size:12px; }
    .sidebar-right .trend .title{ font-weight:700; }
    .sidebar-right .show-more{ color:#1d9bf0; cursor:pointer; font-size:14px; margin-top:8px; }

    /* Search box (nếu trang nào khác chút, block này sẽ đồng bộ luôn) */
    .sidebar-right .search-box{ margin-bottom:20px; position:relative; }
    .sidebar-right .search-box input{
      width:100%; padding:10px 12px 10px 38px;
      background:#16181c; border:1px solid #2f3336; border-radius:25px; color:#fff; font-size:14px;
    }
    .sidebar-right .search-box i{
      position:absolute; top:50%; left:14px; transform:translateY(-50%); color:#8899a6;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar Left -->
    <div class="sidebar-left">
      <div>
        <div class="logo">
          <i class="fas fa-leaf"></i>
          <span>ZenSocial</span>
        </div>
        <div class="menu">
          <div class="menu-item"><a href="{{ url_for('home') }}"><i class="fas fa-home"></i> Home</a></div>
          <div class="menu-item"><a href="{{ url_for('notifications') }}"><i class="far fa-bell"></i> Notifications</a></div>
          <div class="menu-item"><a href="{{ url_for('messenger') }}"><i class="far fa-envelope"></i> Messages</a></div>
          <div class="menu-item"><a href="{{ url_for('profile') }}"><i class="far fa-user"></i> Profile</a></div>
          <div class="menu-item"><a href="{{ url_for('earn') }}"><i class="fas fa-coins"></i> Earn</a></div>
          <div class="menu-item"><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></div>
        </div>
      </div>
      <button class="post-btn" id="sidebarPostBtn">Post</button>
    </div>

    <!-- Feed -->
    <div class="feed">
      <!-- Composer -->
      <div class="composer">
        <div style="display:flex; align-items:center; gap:10px;">
          <img src="{{ avatar_url or url_for('static', filename='default_avatar.png') }}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
          <select style="background:#16181c; color:#A6FF4D; border:none; font-size:13px; cursor:pointer;">
            <option>Everyone</option>
            <option>Followers only</option>
          </select>
        </div>
        <textarea id="postContent" placeholder="What's happening?" rows="3"></textarea>
        <input type="file" id="postMedia" accept="image/*,video/*" style="display:none;">
        <p style="font-size:12px; color:#1d9bf0; margin:5px 0 10px;">Everyone can reply</p>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px;">
          <div style="display:flex; gap:15px; color:#1d9bf0; font-size:16px;">
            <i class="far fa-image" style="cursor:pointer;" onclick="document.getElementById('postMedia').click()"></i>
            <i class="fas fa-poll-h" style="cursor:pointer;" onclick="alert('Poll feature coming soon!')"></i>
            <i class="far fa-smile" style="cursor:pointer;" onclick="alert('Emoji picker coming soon!')"></i>
            <i class="fas fa-map-marker-alt" style="cursor:pointer;" onclick="alert('Location feature coming soon!')"></i>
          </div>
          <button onclick="submitPost()">Post</button>
        </div>
      </div>

      <!-- Example Post -->
      <div class="post-card">
        <div class="post-card-header">
          <img src="{{ url_for('static', filename='default_avatar.png') }}">
          <div class="post-info">
            <h3>@alice</h3>
            <p>Welcome to ZenSocial 🎉</p>
          </div>
        </div>
        <div class="post-actions">
          <span>
            <i class="far fa-comment" onclick="openCommentModal(1)"></i>
            <span id="comments-1">0</span>
          </span>
          <span>
            <i class="fas fa-retweet" onclick="repostPost(1)" id="repost-icon-1"></i>
            <span id="shares-1">0</span>
          </span>
          <span>
            <i class="far fa-heart" onclick="likePost(1)" id="like-icon-1"></i>
            <span id="likes-1">0</span>
          </span>
          <i class="fas fa-share"></i>
        </div>
        <div class="comments" id="comments-list-1" style="display:none; margin-top:10px; font-size:14px; color:#ccc;"></div>
      </div>
    </div>

    <!-- Sidebar Right -->
    <div class="sidebar-right">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search">
        <div class="search-suggestions" id="suggestions"></div>
      </div>

    <div class="card whats">
      <h3>What’s happening</h3>

      <div class="trend">
        <div class="meta">Trending in Vietnam</div>
        <div class="title">ZenChain v2 Launch</div>
        <div class="meta">24K posts</div>
      </div>

      <div class="trend">
        <div class="meta">Technology • Trending</div>
        <div class="title">AI Agents for Social</div>
        <div class="meta">18K posts</div>
      </div>

      <div class="trend">
        <div class="meta">Crypto • Trending</div>
        <div class="title">Layer-2 gas fees</div>
        <div class="meta">12K posts</div>
      </div>

      <div class="show-more">Show more</div>
    </div>
    </div>
  </div>

  <!-- Modal Comment -->
  <div id="commentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCommentModal()">&times;</span>
      <h3>Write a comment</h3>
      <textarea id="commentContent" rows="3" style="width:100%; background:#000; color:#fff; border:none; resize:none; font-size:14px; padding:8px;"></textarea>
      <button onclick="submitComment()" style="margin-top:10px; padding:8px 15px; background:#A6FF4D; border:none; border-radius:20px; color:#000; font-weight:600; cursor:pointer;">Comment</button>
    </div>
  </div>

  <!-- Create Post Modal (UI mới) -->
  <div id="postModal" class="modal" style="display:none;">
    <div class="zs-modal-card">
      <!-- Header -->
      <div class="zs-mh">
        <button class="zs-close" type="button" onclick="closePostModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <a class="zs-drafts" href="javascript:void(0)" onclick="alert('Drafts coming soon!')">Drafts</a>
      </div>

      <!-- User + visibility -->
      <div class="zs-userrow">
        <img src="{{ avatar_url or url_for('static', filename='default_avatar.png') }}" class="zs-avatar" alt="">
        <button class="zs-visibility" type="button" title="Visibility">
          <span class="zs-dot"></span>
          <span>Everyone</span>
          <i class="fa-solid fa-chevron-down"></i>
        </button>
      </div>

      <!-- Editor -->
      <div class="zs-editor">
        <textarea id="modalPostContent" placeholder="What's happening?"></textarea>

        <!-- preview -->
        <div id="modalPreview" class="zs-preview" style="display:none;">
          <img id="modalPreviewImg" alt="" style="display:none;">
          <video id="modalPreviewVideo" controls style="display:none;"></video>
        </div>

        <!-- file input ẩn -->
        <input type="file" id="modalPostMedia" accept="image/*,video/*" hidden>
      </div>

      <!-- reply note -->
      <div class="zs-reply">Everyone can reply</div>

      <!-- Toolbar + Post -->
      <div class="zs-toolbar">
        <div class="zs-tools">
          <i id="modalFileTrigger" class="fa-regular fa-image" title="Add image/video"></i>
          <i class="fa-solid fa-square-poll-horizontal" title="Poll" onclick="alert('Poll coming soon!')"></i>
          <i class="fa-regular fa-face-smile" title="Emoji" onclick="alert('Emoji picker coming soon!')"></i>
          <i class="fa-solid fa-location-dot" title="Location" onclick="alert('Location coming soon!')"></i>
        </div>
        <button id="modalPostBtn" type="button" class="zs-postbtn" onclick="submitPostModal()">Post</button>
      </div>
    </div>
  </div>


  <script>
    // === Search box ===
    const suggestionsData = ["ZenChain", "ZenSocial", "Web3", "Blockchain", "AI", "Crypto"];
    const input = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("suggestions");

    input.addEventListener("input", () => {
      const value = input.value.toLowerCase();
      suggestionsBox.innerHTML = "";
      if (value) {
        const filtered = suggestionsData.filter(item => item.toLowerCase().includes(value));
        if (filtered.length > 0) {
          filtered.forEach(item => {
            const div = document.createElement("div");
            div.textContent = "#" + item;
            div.onclick = () => { input.value = "#" + item; suggestionsBox.style.display = "none"; };
            suggestionsBox.appendChild(div);
          });
          suggestionsBox.style.display = "flex";
        } else suggestionsBox.style.display = "none";
      } else suggestionsBox.style.display = "none";
    });

    document.addEventListener("click", (e) => {
      if (!document.querySelector(".search-box").contains(e.target)) {
        suggestionsBox.style.display = "none";
      }
    });

    // === Post logic ===
    async function submitPost() {
      const content = document.getElementById("postContent").value.trim();
      const media = document.getElementById("postMedia").files[0];
      if (!content && !media) { alert("Write something or add media!"); return; }

      const formData = new FormData();
      formData.append("content", content);
      if (media) formData.append("media", media);

      const response = await fetch("/create_post", { method: "POST", body: formData });
      const data = await response.json();

      if (response.ok && data.success) {
        const feed = document.querySelector(".feed");
        const newPost = document.createElement("div");
        newPost.className = "post-card";
        newPost.innerHTML = `
          <div class="post-card-header">
            <img src="${data.avatar}">
            <div class="post-info">
              <h3>@${data.username}</h3>
              <p>${data.content}</p>
              ${data.media ? `<img src="${data.media}" style="max-width:100%; margin-top:8px; border-radius:10px;">` : ""}
            </div>
          </div>
          <div class="post-actions">
            <span>
              <i class="far fa-comment" onclick="openCommentModal(${data.post_id})"></i>
              <span id="comments-${data.post_id}">0</span>
            </span>
            <span>
              <i class="fas fa-retweet" onclick="repostPost(${data.post_id})" id="repost-icon-${data.post_id}"></i>
              <span id="shares-${data.post_id}">0</span>
            </span>
            <span>
              <i class="far fa-heart" onclick="likePost(${data.post_id})" id="like-icon-${data.post_id}"></i>
              <span id="likes-${data.post_id}">0</span>
            </span>
            <i class="fas fa-share"></i>
          </div>
          <div class="comments" id="comments-list-${data.post_id}" style="display:none; margin-top:10px; font-size:14px; color:#ccc;"></div>
        `;
        feed.insertBefore(newPost, feed.children[1]);
        document.getElementById("postContent").value = "";
        document.getElementById("postMedia").value = "";
      } else alert(data.message || "Post failed");
    }

    // === Like / Repost / Comment ===
    async function likePost(postId) {
      const res = await fetch(`/like_post/${postId}`, { method: "POST" });
      if (res.ok) {
        const data = await res.json();
        const span = document.getElementById(`likes-${postId}`);
        const icon = document.getElementById(`like-icon-${postId}`);
        if (data.status === "liked") {
          span.textContent = parseInt(span.textContent) + 1;
          icon.classList.remove("far"); icon.classList.add("fas");
          icon.style.color = "#e0245e";
        } else {
          span.textContent = parseInt(span.textContent) - 1;
          icon.classList.remove("fas"); icon.classList.add("far");
          icon.style.color = "";
        }
      }
    }

    async function repostPost(postId) {
      const res = await fetch(`/repost_post/${postId}`, { method: "POST" });
      if (res.ok) {
        const data = await res.json();
        const span = document.getElementById(`shares-${postId}`);
        const icon = document.getElementById(`repost-icon-${postId}`);
        if (data.status === "reposted") {
          span.textContent = parseInt(span.textContent) + 1;
          icon.style.color = "#17bf63";
        } else {
          span.textContent = parseInt(span.textContent) - 1;
          icon.style.color = "";
        }
      }
    }

    let currentCommentPostId = null;
    function openCommentModal(postId) {
      currentCommentPostId = postId;
      document.getElementById("commentModal").style.display = "block";
    }
    function closeCommentModal() {
      document.getElementById("commentModal").style.display = "none";
    }
    async function submitComment() {
      const content = document.getElementById("commentContent").value.trim();
      if (!content) { alert("Write something!"); return; }
      const res = await fetch(`/comment_post/${currentCommentPostId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        const data = await res.json();
        const list = document.getElementById(`comments-list-${currentCommentPostId}`);
        const div = document.createElement("div");
        div.className = "comment-item";
        div.innerHTML = `<b>@${data.username}</b>: ${data.content}`;
        list.appendChild(div);
        list.style.display = "block";
        const span = document.getElementById(`comments-${currentCommentPostId}`);
        span.textContent = parseInt(span.textContent) + 1;
        closeCommentModal();
        document.getElementById("commentContent").value = "";
      }
    }

document.addEventListener('DOMContentLoaded', () => {
  const sbBtn = document.getElementById('sidebarPostBtn');
  if (sbBtn) sbBtn.addEventListener('click', openPostModal);

  const file = document.getElementById('modalPostMedia');
  const trigger = document.getElementById('modalFileTrigger');
  if (trigger && file) trigger.onclick = () => file.click();
  if (file) file.addEventListener('change', handleModalFilePreview);

  // đóng khi click nền
  window.addEventListener('click', (e) => {
    const m = document.getElementById('postModal');
    if (e.target === m) closePostModal();
  });
});

function openPostModal(){
  const m = document.getElementById('postModal');
  if (m) m.style.display = 'flex'; 
}

function closePostModal(){
  const m = document.getElementById('postModal'); if (!m) return;
  m.style.display = 'none';
  const ta = document.getElementById('modalPostContent'); if (ta) ta.value='';
  const f  = document.getElementById('modalPostMedia'); if (f) f.value='';
  const img = document.getElementById('modalPreviewImg'); if (img){ img.src=''; img.style.display='none'; }
  const vid = document.getElementById('modalPreviewVideo'); if (vid){ vid.pause(); vid.removeAttribute('src'); vid.load(); vid.style.display='none'; }
  const wrap= document.getElementById('modalPreview'); if (wrap) wrap.style.display='none';
}

function handleModalFilePreview(){
  const file = document.getElementById('modalPostMedia');
  const f = file?.files?.[0]; if (!f) return;
  const url = URL.createObjectURL(f);
  const img = document.getElementById('modalPreviewImg');
  const vid = document.getElementById('modalPreviewVideo');
  const wrap= document.getElementById('modalPreview');
  if (f.type.startsWith('image/')){
    if (img){ img.src=url; img.style.display='block'; }
    if (vid){ vid.pause(); vid.removeAttribute('src'); vid.load(); vid.style.display='none'; }
  } else if (f.type.startsWith('video/')){
    if (vid){ vid.src=url; vid.style.display='block'; }
    if (img){ img.src=''; img.style.display='none'; }
  }
  if (wrap) wrap.style.display='block';
}

async function submitPostModal(){
  const btn = document.getElementById('modalPostBtn');
  const content = document.getElementById('modalPostContent').value.trim();
  const media = document.getElementById('modalPostMedia').files[0];
  if (!content && !media){ alert('Write something or add media!'); return; }

  const fd = new FormData();
  fd.append('content', content);
  if (media) fd.append('media', media);

  if (btn){ btn.disabled=true; btn.dataset._old=btn.textContent; btn.textContent='Posting...'; }
  try{
    const res = await fetch('/create_post', { method:'POST', body: fd });
    const data = await res.json();
    if (res.ok && data.success){
      // chèn post mới vào feed (giống submitPost())
      const feed = document.querySelector('.feed');
      if (feed){
        const el = document.createElement('div');
        el.className = 'post-card';
        el.innerHTML = `
          <div class="post-card-header">
            <img src="${data.avatar}">
            <div class="post-info">
              <h3>@${data.username}</h3>
              <p>${data.content || ''}</p>
              ${data.media ? `<img src="${data.media}" style="max-width:100%; margin-top:8px; border-radius:10px;">` : ''}
            </div>
          </div>
          <div class="post-actions">
            <span>
              <i class="far fa-comment" onclick="openCommentModal(${data.post_id})"></i>
              <span id="comments-${data.post_id}">0</span>
            </span>
            <span>
              <i class="fas fa-retweet" onclick="repostPost(${data.post_id})" id="repost-icon-${data.post_id}"></i>
              <span id="shares-${data.post_id}">0</span>
            </span>
            <span>
              <i class="far fa-heart" onclick="likePost(${data.post_id})" id="like-icon-${data.post_id}"></i>
              <span id="likes-${data.post_id}">0</span>
            </span>
            <i class="fas fa-share"></i>
          </div>
          <div class="comments" id="comments-list-${data.post_id}" style="display:none; margin-top:10px; font-size:14px; color:#ccc;"></div>
        `;
        feed.insertBefore(el, feed.children[1]);
      }
      closePostModal();
    } else {
      alert(data.message || 'Post failed');
    }
  } catch(e){
    alert('Post failed');
  } finally {
    if (btn){ btn.disabled=false; btn.textContent = btn.dataset._old || 'Post'; delete btn.dataset._old; }
  }
}
    
  </script>
</body>
</html>
