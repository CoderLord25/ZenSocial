<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ZenID Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;

      /* Background image */
      background: url("{{ url_for('static', filename='images/zenchain1_bg.jpg') }}") no-repeat center center fixed;
      background-size: cover;
    }
    .container {
      background: rgba(22, 24, 28, 0.92); /* h∆°i trong su·ªët ƒë·ªÉ th·∫•y ·∫£nh n·ªÅn */
      padding: 60px;
      border-radius: 16px;
      width: 550px;
      max-width: 95%;
      text-align: center;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
    }
    h1 {
      color: #A6FF4D;
      margin-bottom: 25px;
      font-size: 32px;
    }
    .btn {
      background: #A6FF4D;
      border: none;
      border-radius: 30px;
      padding: 14px 28px;
      margin: 12px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 18px;
      color: #000;
      transition: 0.2s;
    }
    .btn:hover {
      background: #90e63c;
    }
    input {
      width: 100%;
      padding: 14px;
      border-radius: 30px;
      border: 1px solid #2f3336;
      background: #000;
      color: #fff;
      margin-bottom: 18px;
      font-size: 16px;
    }
    input:focus {
      outline: none;
      border: 1px solid #A6FF4D;
    }
    .zenid-card {
      margin-top: 20px;
      background: #0d0f11;
      border-radius: 12px;
      padding: 25px;
    }
    .zenid-card img {
      max-width: 200px;
      margin-bottom: 18px;
    }
    .address {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 15px;
      word-break: break-all;
      color: #A6FF4D;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ZenSocial</h1>
    <div id="step1">
      <p>Do you already own a ZenID?</p>
      <button class="btn" onclick="showLogin()">Login with ZenID</button>
      <button class="btn" onclick="mintZenID()">Mint ZenID</button>
      <!-- N√∫t Connect Wallet -->
      <button class="btn" onclick="connectWallet()">Connect Wallet</button>
    </div>

    <!-- ZenID Login -->
    <div id="loginForm" style="display:none;">
      <input type="text" id="zenidInput" placeholder="Enter your ZenID address">
      <button class="btn" onclick="login()">Login</button>
    </div>

    <!-- Mint Success -->
    <div id="mintSuccess" style="display:none;">
      <div class="zenid-card">
        <img src="{{ url_for('static', filename='images/ZenID.jpg') }}" alt="ZenID">
        <h2>Congratulations! üéâ</h2>
        <p>You have successfully joined <b>ZenCommunity</b></p>
        <p class="address" id="generatedAddress"></p>
        <button class="btn" onclick="backToLogin()">Back to Login</button>
      </div>
    </div>
  </div>

  <script>
    // Ki·ªÉm tra MetaMask khi load trang
    window.addEventListener("load", () => {
      if (typeof window.ethereum === "undefined") {
        console.warn("MetaMask not found. Please install it to use Connect Wallet.");
      } else {
        console.log("MetaMask detected:", window.ethereum);
      }
    });

    function showLogin() {
      document.getElementById("step1").style.display = "none";
      document.getElementById("mintSuccess").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }

    function mintZenID() {
      const chars = "abcdef0123456789";
      let addr = "0x";
      for (let i = 0; i < 40; i++) {
        addr += chars[Math.floor(Math.random() * chars.length)];
      }

      fetch("/register_zenid", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ zenid: addr })
      });

      document.getElementById("step1").style.display = "none";
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("mintSuccess").style.display = "block";
      document.getElementById("generatedAddress").textContent = addr;
    }

    function backToLogin() {
      document.getElementById("mintSuccess").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("zenidInput").value = document.getElementById("generatedAddress").textContent;
    }

    function login() {
      const zenid = document.getElementById("zenidInput").value;
      if (zenid.trim() === "") {
        alert("Please enter your ZenID address!");
        return;
      }
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/login";
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "zenid";
      input.value = zenid;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }

    // H√†m Connect Wallet ƒë√£ s·ª≠a
    async function connectWallet() {
      if (typeof window.ethereum === "undefined") {
        alert("MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ho·∫∑c ch∆∞a b·∫≠t tr√™n tr√¨nh duy·ªát!");
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        if (!accounts || accounts.length === 0) {
          alert("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v√≠ n√†o!");
          return;
        }

        const walletAddress = accounts[0];
        console.log("Connected wallet:", walletAddress);
        alert("ƒê√£ k·∫øt n·ªëi v√≠: " + walletAddress);

        // G·ª≠i ƒë·ªãa ch·ªâ v√≠ v·ªÅ server ƒë·ªÉ login
        const res = await fetch("/wallet_login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: walletAddress })
        });

        const data = await res.json();
        if (data.success) {
          window.location.href = "/profile";
        } else {
          alert("Wallet login failed: " + (data.error || ""));
        }
      } catch (err) {
        console.error("Connect wallet error:", err);
        alert("K·∫øt n·ªëi v√≠ th·∫•t b·∫°i ho·∫∑c b·∫°n ƒë√£ t·ª´ ch·ªëi!");
      }
    }
  </script>
</body>
</html>
